<?xml version="1.0" encoding="UTF-8"?>
<project basedir=".">
    
    <property name="clover.search.path" value="lib"/>

    <target name="-init-clover-initstring" unless="clover.init.string">
        <property name="clover.init.string" location=".clover/clover.db"/>
    </target>

    <target name="-init-clover" depends="-init-clover-initstring">
        <path id="clover.classpath">
            <fileset dir="lib" includes="*clover*.jar"/>
            <fileset dir="${clover.search.path}" includes="*clover*.jar"/>
        </path>

        <taskdef resource="cloverlib.xml" classpathref="clover.classpath"/>
        <taskdef resource="cloverjunitlib.xml" classpathref="clover.classpath"/>

        <condition property="clover.installed">
            <and>
                <available classname="com.cenqua.clover.CloverInstr"/>
                <or>
                    <available file="lib/clover.license"/>
                    <available file="${clover.search.path}/clover.license"/>
                </or>
            </and>
        </condition>
    </target>
    
    <target name="clover.snapshot" depends="with.clover" if="clover.installed">
        <clover-snapshot/>
    </target>
    
        <target name="clover.xml" if="clover.installed" depends="-init-clover"
            description="Generate a Clover XML report.">
        <mkdir dir="reports/clover" />
        <clover-report>
            <current outfile="reports/clover/clover.xml">
                <format type="xml" filter="private_ctor"/>
            </current>
        </clover-report>
    </target>

    <target name="clover.html" if="clover.installed" depends="-init-clover"
            description="Generate a Clover HTML report.">
        <mkdir dir="reports/clover" />
        <mkdir dir="reports/clover/history" />
        <clover-historypoint historydir="reports/clover/history" />
        <clover-report>
            <current outfile="reports/clover">
                <format type="html" filter="private_ctor"/>
             </current>
             <historical outfile="reports/clover" historydir="reports/clover/history" />
        </clover-report>
    </target>

    <target name="with.clover" depends="-init-clover" if="clover.installed"
            description="Set up Clover to instrument tests.">
        <clover-env/>
        <clover-setup initstring="${clover.init.string}"/>
    </target>
    
    <target name="test-html" depends="with.clover,compile-test,test,clover.html,clover.snapshot"
            description="Run tests and generate a Clover HTML report."/>
    <target name="test-xml" depends="with.clover,compile-test,test,clover.xml,clover.snapshot"
            description="Run tests and generate a Clover XML report."/>
    <target name="test-both" depends="with.clover,compile-test,test,clover.html,clover.xml,clover.snapshot"
            description="Run tests and generate Clover XML and HTML reports."/>

    <target name="teamcity-clover-report">
        <xslt in="reports/clover/clover.xml" style="checkstyle/clover.xsl" out="teamcity-info.xml" />
    </target>

</project>
